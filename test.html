<html>

<head>
  <meta charset="" utf-8">
</head>
<button id="run">Run</button>
<button id="test">Test</button>
<script src="third_party/encoding.js"></script>
<script type="module">
  import { FatFs } from "./fs/fat_fs.js"
  import { NativeFs } from "./fs/native_fs.js"
  import { XdfImage } from "./image/xdf_image.js"
  import { NativeIo } from "./io/native_io.js"

  const io = new NativeIo();
  //const out = new NativeIo();
  document.getElementById('run').addEventListener('click', async e => {
    await io.choose();
    //await out.choose();
    const xdf = new XdfImage();
    await xdf.open(io);
    const fat = new FatFs();
    await fat.open(xdf);
    document.getElementById('test').addEventListener('click', async e => {
      await fat.flush();
      await fat.chdir('123456789ABCDEFGH.IJK');
      await fat.list(entry => {
        console.log(entry);
      });
      await fat.chdir('..');
    });
    /*
    console.log(await fat.getAttributes());
    await fat.list(entry => {
      console.log(entry);
    });
    try {
      await fat.chdir('newdir');
      console.log(await fat.getCwd());
      await fat.list(entry => {
        console.log(entry);
      });
      await fat.chdir('..');
      console.log(await fat.getCwd());
    } catch (e) { console.log(e); }
    //const newFile = await fat.getIo('NEW', { create: true });
    console.log('mkdir');
    await fat.mkdir('newdir');
    //    await fat.flush();
    await fat.list(entry => {
      console.log(entry);
    });
    console.log('chdir');
    await fat.chdir('newdir');
    console.log(await fat.getCwd());
    for (let i = 0; i < 256; ++i) {
      await fat.getIo(i.toString(), { create: true });
    }
    await fat.chdir('..');
    //await fat.remove('newdir');
    //await fat.remove('config.BAK');
    //fat.close();
    */
    const file = await fat.getIo('CART.GB');
    //const file = await fat.getIo('COPY');
    const out = await fat.getIo('COPY', { create: true });
    console.log(file);
    while (true) {
      const data = await file.read(1024);
      console.log(data);
      if (data.byteLength == 0) {
        console.log('break');
        break;
      }
      await out.write(data);
    }
    await file.truncate(32);
    out.close();
    fat.close();
  });
</script>

</html>